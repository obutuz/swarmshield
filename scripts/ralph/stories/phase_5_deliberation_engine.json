{
  "branchName": "ralph/phase-5-deliberation",
  "description": "Multi-agent Opus 4.6 deliberation engine. Spawns parallel AI agents to analyze flagged events, facilitates structured debate, and reaches consensus verdicts.",
  "phase": 5,
  "phaseName": "Deliberation Engine",
  "crossPhaseLinks": {
    "phase_1_auth_foundation": "Audit entries created for all deliberation actions. Workspace scoping.",
    "phase_2_core_schemas": "Uses AgentDefinition, PromptTemplate, Workflow, WorkflowStep, ConsensusPolicy, AnalysisSession, AgentInstance, DeliberationMessage, Verdict schemas.",
    "phase_3_policy_engine": "Flagged events from PolicyEngine trigger deliberation.",
    "phase_4_api_gateway": "Gateway publishes {:trigger_deliberation, event, workflow} via PubSub.",
    "phase_6_dashboard_liveviews": "DeliberationShowLive displays real-time debate via PubSub.",
    "phase_7_admin_liveviews": "Admin manages workflows, agent definitions, prompt templates, consensus policies."
  },
  "securityRules": {
    "prompt_injection": "LLM calls use Anthropic structured message format - system prompt in system parameter, user event content in user role. NEVER embed raw event content in system prompt strings.",
    "workspace_scoping": "All context functions enforce workspace_id. Session GenServer verifies event and workflow belong to same workspace.",
    "no_code_execution": "PromptRenderer uses safe String.replace/3 only. NEVER Code.eval_string, EEx.eval_string, or dynamic code generation.",
    "input_validation": "Vote values validated against explicit allowlist. LLM responses parsed safely with error handling. Template variables use literal substitution only.",
    "ssrf_prevention": "LLM client ONLY calls configured Anthropic API endpoint from runtime config. NEVER construct target URL from user input or database fields.",
    "audit_trail": "Session lifecycle, verdict creation, and budget limit events all create audit_entry records.",
    "atom_safety": "Vote values and decision enums use String.to_existing_atom or explicit allowlists. NEVER create atoms from arbitrary user/LLM input."
  },
  "userStories": [
    {
      "id": "DELIB-001",
      "title": "Create Deliberation context",
      "description": "Deliberation context manages AnalysisSession, AgentInstance, DeliberationMessage, and Verdict CRUD. Provides the data layer for the deliberation engine.",
      "priority": 1,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "Context at lib/swarmshield/deliberation.ex",
        "AnalysisSession CRUD: list_analysis_sessions/1 (by workspace_id, filterable by status/date, paginated, preload verdict), get_analysis_session!/1 (preload agent_instances, messages, verdict), create_analysis_session/1, update_analysis_session/2",
        "AgentInstance CRUD: list_agent_instances/1 (by session_id), get_agent_instance!/1, create_agent_instance/1, update_agent_instance/2",
        "DeliberationMessage: create_deliberation_message/1, list_messages_by_session/1 (ordered by round then inserted_at), list_messages_by_instance/1",
        "Verdict: create_verdict/1, get_verdict_by_session/1",
        "All list functions include preloads (no N+1)",
        "PubSub broadcast on session status changes: 'deliberations:workspace_id'",
        "Tests for all CRUD operations",
        "Edge case: list_analysis_sessions/1 with status filter returns only matching sessions",
        "Edge case: get_analysis_session!/1 raises Ecto.NoResultsError for missing ID",
        "Edge case: update_analysis_session/2 validates status transitions (no going backwards)",
        "Edge case: list_messages_by_session/1 returns messages ordered by round ASC, inserted_at ASC",
        "Edge case: get_verdict_by_session/1 returns nil for sessions without verdict",
        "Edge case: all preloads verified via Ecto.assoc_loaded?/1 in tests",
        "Minimum 20 test cases",
        "SECURITY: All query functions must enforce workspace_id as mandatory parameter - NEVER return cross-workspace sessions or verdicts",
        "SECURITY: Session lifecycle changes (started, completed, failed) must create audit_entry records",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-002",
      "title": "Create Agents context",
      "description": "Agents context manages AgentDefinition and PromptTemplate CRUD. These are the configuration entities that define how AI agents behave during deliberation.",
      "priority": 2,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Agent definitions and prompt templates are database-driven - ZERO hardcoded agent personas or prompts",
        "Context at lib/swarmshield/agents.ex",
        "AgentDefinition CRUD: list_agent_definitions/1 (by workspace_id, filterable), get_agent_definition!/1, create_agent_definition/1, update_agent_definition/2, delete_agent_definition/1, list_enabled_agent_definitions/1",
        "PromptTemplate CRUD: list_prompt_templates/1 (by workspace_id, filterable by category), get_prompt_template!/1, create_prompt_template/1, update_prompt_template/2, delete_prompt_template/1",
        "All list functions include preloads",
        "Tests for all CRUD operations",
        "Edge case: delete_agent_definition/1 with active workflow steps returns error (referential integrity)",
        "Edge case: list_enabled_agent_definitions/1 returns only enabled=true definitions",
        "Edge case: list_prompt_templates/1 filtered by category returns only matching templates",
        "Edge case: delete_prompt_template/1 that is referenced by workflow steps returns error",
        "Minimum 12 test cases",
        "SECURITY: Changesets must NEVER cast [:workspace_id] from user input - set server-side from current_user's workspace",
        "SECURITY: All CRUD operations on agent definitions and prompt templates must create audit_entry records",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-003",
      "title": "Create Workflows context",
      "description": "Workflows context manages Workflow, WorkflowStep, and ConsensusPolicy CRUD. Provides pipeline configuration for the deliberation engine.",
      "priority": 3,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Workflow steps, ordering, and consensus policies are database-driven - ZERO hardcoded pipeline configurations",
        "Context at lib/swarmshield/workflows.ex",
        "Workflow CRUD: list_workflows/1 (by workspace_id, preload steps), get_workflow!/1 (preload steps with agent_definitions), create_workflow/1, update_workflow/2, delete_workflow/1, get_enabled_workflow_for_trigger/2 (workspace_id, trigger_type)",
        "WorkflowStep CRUD: list_workflow_steps/1 (by workflow_id, ordered by position), create_workflow_step/1, update_workflow_step/2, delete_workflow_step/1, reorder_workflow_steps/2 (workflow_id, ordered_ids)",
        "ConsensusPolicy CRUD: list_consensus_policies/1 (by workspace_id), get_consensus_policy!/1, create_consensus_policy/1, update_consensus_policy/2, delete_consensus_policy/1",
        "All list functions preload associations",
        "Tests for all CRUD + step reordering",
        "Edge case: get_enabled_workflow_for_trigger/2 returns nil when no matching workflow",
        "Edge case: get_enabled_workflow_for_trigger/2 with :all trigger matches any event status",
        "Edge case: reorder_workflow_steps/2 validates all step IDs belong to the workflow",
        "Edge case: reorder_workflow_steps/2 updates positions atomically (Ecto.Multi)",
        "Edge case: delete_workflow/1 cascades to workflow_steps",
        "Edge case: get_workflow!/1 preloads steps with their agent_definitions (2-level preload)",
        "Minimum 15 test cases",
        "SECURITY: Changesets must NEVER cast [:workspace_id] from user input - set server-side from current_user's workspace",
        "SECURITY: reorder_workflow_steps/2 must validate caller has permission to modify the workflow",
        "SECURITY: All CRUD on workflows, steps, and consensus policies must create audit_entry records",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-004",
      "title": "Create PromptRenderer module",
      "description": "Pure-function module that renders prompt templates by interpolating variables. Takes a template string with {{variable}} placeholders and a map of values, returns the rendered string.",
      "priority": 4,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Templates loaded from database PromptTemplate records - renderer is a pure function, content comes from DB",
        "Module at lib/swarmshield/deliberation/prompt_renderer.ex",
        "render/2 - (template_string, variables_map) returns {:ok, rendered_string} or {:error, :missing_variables, [names]}",
        "Replaces all {{variable_name}} occurrences with corresponding map values",
        "Returns error if required variables are missing from the map",
        "extract_variables/1 - returns list of variable names from template",
        "validate_template/2 - (template, available_variables) returns :ok or {:error, missing}",
        "Handles edge cases: empty template, no variables, extra variables (ignored)",
        "Pure functions - no side effects",
        "Pattern matching throughout",
        "Tests for rendering, missing variables, edge cases",
        "Edge case: render/2 with empty template returns {:ok, ''}",
        "Edge case: render/2 with no variables in template ignores provided variables",
        "Edge case: render/2 with {{}} (empty variable name) is treated as literal text",
        "Edge case: render/2 with nested {{{{var}}}} treats inner braces as literal",
        "Edge case: render/2 with same variable used multiple times replaces all occurrences",
        "Edge case: render/2 with variable value containing {{other}} does NOT recursively expand",
        "Edge case: validate_template/2 reports all missing variables (not just first)",
        "Minimum 10 test cases",
        "SECURITY: render/2 must NEVER use Code.eval_string or EEx.eval_string - only safe String.replace/3 with literal variable substitution",
        "SECURITY: Rendered output that may be displayed in LiveViews must be HTML-safe (document if output is LLM-only vs UI-displayed)",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-005",
      "title": "Create LLM Budget Agent",
      "description": "GenServer that tracks API spending per workspace. Enforces budget limits to prevent runaway costs. Uses ETS for fast lookups.",
      "priority": 5,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "Module at lib/swarmshield/llm/budget.ex",
        "GenServer with named process: Swarmshield.LLM.Budget",
        "ETS table :llm_budget for workspace spending tracking",
        "track_usage/3 - (workspace_id, tokens, cost_cents) records usage",
        "check_budget/1 - (workspace_id) returns {:ok, remaining} or {:error, :budget_exceeded}",
        "get_usage/1 - (workspace_id) returns %{total_tokens: N, total_cost_cents: N, period_start: datetime}",
        "reset_usage/1 - (workspace_id) resets counters for new billing period",
        "Default budget limit from workspace settings (configurable, database-driven)",
        "handle_continue wrapped in try/rescue",
        "All ETS reads rescue ArgumentError",
        "Added to application supervision tree",
        "Tests for tracking, budget check, exceeded budget, reset",
        "Edge case: track_usage/3 with 0 tokens and 0 cost is valid (no-op tracking)",
        "Edge case: check_budget/1 for workspace with no limit returns {:ok, :unlimited}",
        "Edge case: check_budget/1 for workspace with no usage returns {:ok, full_budget}",
        "Edge case: concurrent track_usage/3 calls are atomic (ETS update_counter)",
        "Edge case: reset_usage/1 for workspace with no usage is idempotent",
        "Edge case: ETS table destroyed - all reads return safe defaults",
        "Minimum 8 test cases",
        "SECURITY: track_usage/3 must validate tokens and cost_cents are non-negative (prevent negative values inflating budget)",
        "SECURITY: Budget limit exceeded events must create audit_entry records",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-006",
      "title": "Create LLM Client module",
      "description": "HTTP client for calling Claude Opus 4.6 API via ReqLLM. Includes retries, timeouts, token counting, and cost tracking. All LLM calls go through this module.",
      "priority": 6,
      "passes": false,
      "dependsOn": [
        "DELIB-005"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "Module at lib/swarmshield/llm/client.ex",
        "chat/2 - (messages, opts) calls Anthropic API via ReqLLM, returns {:ok, response} or {:error, reason}",
        "Options: model (default claude-opus-4-6), temperature, max_tokens, system_prompt",
        "Retry logic: 3 retries with exponential backoff for 429/500/502/503",
        "Timeout: configurable, default 60 seconds",
        "Extracts token usage from response: input_tokens, output_tokens",
        "Calculates cost in cents based on model pricing",
        "Calls Budget.track_usage/3 after each successful call",
        "Checks Budget.check_budget/1 BEFORE making call",
        "API key from runtime config (Application.get_env), never hardcoded",
        "Tests with mocked HTTP responses (success, rate limit, error)",
        "Edge case: API key missing from config returns {:error, :api_key_not_configured}",
        "Edge case: budget exceeded before call returns {:error, :budget_exceeded} without making HTTP request",
        "Edge case: 429 rate limit response triggers retry with exponential backoff",
        "Edge case: 500/502/503 responses trigger retry",
        "Edge case: 400/401/403 responses do NOT trigger retry (client errors are not retryable)",
        "Edge case: timeout after configured seconds returns {:error, :timeout}",
        "Edge case: response with missing usage field logs warning, uses 0 tokens",
        "Edge case: cost calculation uses correct per-model pricing from config (not hardcoded)",
        "Minimum 10 test cases (using mocked HTTP)",
        "SECURITY: LLM prompt injection prevention - use Anthropic API structured message format. System prompt in system parameter, user content in user role. NEVER embed raw event content in system prompt string",
        "SECURITY: SSRF prevention - HTTP client must ONLY call configured Anthropic API endpoint from runtime config. NEVER construct URL from user input or database fields",
        "SECURITY: LLM response parsing must handle malformed JSON safely - try/rescue on Jason.decode, never crash the calling process",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-007",
      "title": "Create Deliberation Session GenServer",
      "description": "GenServer managing the lifecycle of a single deliberation session. Started under DynamicSupervisor, orchestrates analysis -> deliberation -> voting -> verdict phases.",
      "priority": 7,
      "passes": false,
      "dependsOn": [
        "DELIB-001",
        "DELIB-002",
        "DELIB-003",
        "DELIB-004",
        "DELIB-005",
        "DELIB-006"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "Module at lib/swarmshield/deliberation/session.ex",
        "GenServer started via DynamicSupervisor: Swarmshield.Deliberation.SessionSupervisor",
        "DynamicSupervisor added to application supervision tree",
        "start_session/2 - (event, workflow) starts a new session GenServer",
        "Session lifecycle: :pending -> :analyzing -> :deliberating -> :voting -> :completed",
        "State tracks: session_id, event, workflow, agents, messages, current_phase",
        "handle_continue(:start_analysis) kicks off the pipeline",
        "Timeout handling: session-level timeout from workflow config",
        "Error handling: captures errors, updates session status to :failed",
        "PubSub broadcasts on phase transitions: 'deliberation:session_id'",
        "Subscribes to PubSub 'deliberations:workspace_id' for trigger messages",
        "Audit entry created on session start and completion",
        "Tests for session lifecycle, timeout, error recovery",
        "Edge case: start_session/2 with invalid workflow returns {:error, reason}",
        "Edge case: session timeout triggers :timed_out status and GenServer shutdown",
        "Edge case: GenServer crash triggers supervisor restart and session marked :failed",
        "Edge case: duplicate start_session/2 for same event returns existing session (idempotent)",
        "Edge case: PubSub broadcast includes session_id and workspace_id for targeted subscriptions",
        "Edge case: audit entry includes session ID, workflow name, and trigger type",
        "Minimum 10 test cases",
        "SECURITY: start_session/2 must verify event and workflow belong to same workspace as requesting user",
        "SECURITY: Authorization check - verify caller has deliberations:trigger permission before starting session",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-008",
      "title": "Implement analysis phase",
      "description": "Analysis phase: spawn parallel Task.Supervisor tasks for each agent in the workflow. Each agent analyzes the flagged event using its configured prompt and returns an initial assessment.",
      "priority": 8,
      "passes": false,
      "dependsOn": [
        "DELIB-007"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Analysis agents, prompts, and model config loaded from database - ZERO hardcoded analysis behavior",
        "Add analysis phase to Deliberation.Session GenServer",
        "Uses Task.Supervisor (Swarmshield.TaskSupervisor) for parallel agent tasks - NOT Task.async",
        "Task.Supervisor added to application supervision tree",
        "For each workflow step: create AgentInstance, render prompt, call LLM.Client",
        "Extract values from state BEFORE creating tasks (no process state copying)",
        "Collects results with Task.yield_many/2 with timeout",
        "Updates AgentInstance with initial_assessment, vote, confidence",
        "Creates DeliberationMessage (type: :analysis) for each agent's output",
        "Handles partial failures: if some agents timeout, proceed with available results",
        "PubSub broadcast: {:analysis_complete, session_id, results}",
        "Tests for parallel execution, partial failure, timeout handling",
        "Edge case: workflow with 0 steps completes analysis immediately (no agents to run)",
        "Edge case: single agent failure doesn't prevent other agents from completing",
        "Edge case: all agents timeout - session marked as :failed with descriptive error",
        "Edge case: parallel tasks respect Task.Supervisor max_children limit",
        "Edge case: agent values extracted BEFORE spawning tasks (verified no socket/state copying)",
        "Edge case: LLM response parsing handles malformed JSON gracefully",
        "Minimum 8 test cases",
        "SECURITY: LLM prompt injection prevention - when constructing analysis prompts with event content, use Anthropic structured message format. System instructions in system param, event data in user role. NEVER embed raw event content in system prompt",
        "SECURITY: All loaded agent definitions and prompt templates must be verified to belong to the same workspace as the event being analyzed",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-009",
      "title": "Implement deliberation phase",
      "description": "Deliberation phase: agents review each other's analyses and engage in structured debate. Each agent can respond to others' assessments with arguments and counter-arguments.",
      "priority": 9,
      "passes": false,
      "dependsOn": [
        "DELIB-008"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "Add deliberation phase to Deliberation.Session GenServer",
        "Configurable number of deliberation rounds (default 2, from workflow config)",
        "Each round: compile all previous messages, send to each agent for review",
        "Agents produce :argument or :counter_argument messages",
        "Each agent sees all other agents' analyses and arguments",
        "Prompt includes: original event, all previous messages, instruction to debate",
        "Creates DeliberationMessage for each agent response per round",
        "Agents may update their vote/confidence after deliberation",
        "Extract values from state BEFORE creating tasks",
        "PubSub broadcast: {:deliberation_round_complete, session_id, round, messages}",
        "Tests for multi-round deliberation, vote changes",
        "Edge case: 0 deliberation rounds configured skips deliberation phase entirely",
        "Edge case: agent that timed out in analysis is excluded from deliberation",
        "Edge case: agent changes vote after seeing other arguments (vote updated in DB)",
        "Edge case: agent confidence changes after deliberation (tracked per round)",
        "Edge case: deliberation prompt includes ALL previous messages (not just last round)",
        "Minimum 8 test cases",
        "SECURITY: LLM prompt injection prevention - deliberation prompts compile ALL previous messages including user-originated event content. Clearly demarcate system instructions vs user-supplied content to prevent prompt injection via crafted event payloads",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-010",
      "title": "Create Consensus module",
      "description": "Pure-function module implementing voting strategies for reaching verdicts. Supports majority, supermajority, unanimous, and weighted voting.",
      "priority": 10,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Voting strategy, threshold, and weights loaded from database ConsensusPolicy - ZERO hardcoded consensus parameters",
        "Module at lib/swarmshield/deliberation/consensus.ex",
        "evaluate/2 - (votes, consensus_policy) returns {:consensus, decision, details} or {:no_consensus, details}",
        "Majority strategy: >50% of votes agree",
        "Supermajority strategy: >threshold (e.g., 67%) agree",
        "Unanimous strategy: all votes must agree",
        "Weighted strategy: votes weighted by agent role weights from policy",
        "vote_breakdown/1 - returns %{allow: N, flag: N, block: N} from list of votes",
        "confidence_score/1 - returns average confidence across all voters",
        "dissenting_opinions/2 - returns list of agents who disagreed with majority",
        "Pure functions - no side effects",
        "Pattern matching for strategy dispatch",
        "Tests for each strategy, edge cases (tie, single voter, all abstain)",
        "Edge case: single voter always reaches consensus (100% agreement)",
        "Edge case: tie vote (50/50) does NOT reach majority consensus",
        "Edge case: 2 out of 3 voters agree reaches majority (>50%)",
        "Edge case: 2 out of 3 voters agree does NOT reach supermajority at 0.67 threshold",
        "Edge case: unanimous with 1 dissenter returns :no_consensus",
        "Edge case: weighted voting with 0-weight agent effectively excludes that agent",
        "Edge case: all agents abstain (nil vote) returns :no_consensus",
        "Edge case: confidence_score/1 with mix of nil and valid confidences ignores nils",
        "Minimum 15 test cases",
        "SECURITY: Vote values must be validated against explicit allowlist [:allow, :flag, :block, :abstain] - reject unexpected atoms to prevent atom table exhaustion",
        "SECURITY: Weighted strategy must validate weights are non-negative numbers - negative weights could invert voting outcomes",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DELIB-011",
      "title": "Implement verdict phase",
      "description": "Verdict phase: collect final votes from all agents, apply consensus policy, create Verdict record, update session status, create audit entry.",
      "priority": 11,
      "passes": false,
      "dependsOn": [
        "DELIB-009",
        "DELIB-010"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Verdict decision thresholds from database ConsensusPolicy - action mapping from database rules",
        "Add verdict phase to Deliberation.Session GenServer",
        "Collects final votes from all AgentInstances",
        "Calls Consensus.evaluate/2 with votes and session's consensus_policy",
        "Creates Verdict record with: decision, confidence, reasoning, vote_breakdown, dissenting_opinions",
        "Updates AnalysisSession status to :completed, sets completed_at, total_tokens_used, total_cost_cents",
        "Updates original AgentEvent status based on verdict decision",
        "Creates AuditEntry for verdict",
        "PubSub broadcast: {:verdict_reached, session_id, verdict}",
        "If no consensus: verdict decision defaults to :escalate",
        "GenServer stops after verdict (normal shutdown)",
        "Tests for consensus reached, no consensus, verdict persistence",
        "Edge case: no consensus reached - verdict decision is :escalate",
        "Edge case: verdict with :block decision updates original event to :blocked",
        "Edge case: verdict with :allow decision updates original event to :allowed",
        "Edge case: total_tokens_used sums all agent_instances tokens",
        "Edge case: total_cost_cents sums all agent_instances costs",
        "Edge case: GenServer sends :normal shutdown after verdict (not crash)",
        "Edge case: audit entry for verdict includes decision, confidence, and vote breakdown",
        "Minimum 8 test cases",
        "SECURITY: Verdict decision must validate against explicit allowlist [:allow, :flag, :block, :escalate] - prevent arbitrary atom creation",
        "SECURITY: Updating original AgentEvent status based on verdict must verify workspace scoping",
        "SECURITY: Verdict creation must create audit_entry record (security decision)",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    }
  ]
}