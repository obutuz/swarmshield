{
  "branchName": "ralph/phase-2-schemas",
  "description": "All domain schemas needed before building the gateway or deliberation engine. These represent the core entities of the AI Agent Firewall.",
  "phase": 2,
  "phaseName": "Core Domain Schemas",
  "crossPhaseLinks": {
    "phase_1_auth_foundation": "All schemas belong_to workspace (from Phase 1). Users created in Phase 1 are referenced by agent events and audit entries.",
    "phase_3_policy_engine": "PolicyRule and DetectionRule schemas are loaded into ETS by PolicyCache. PolicyViolation links events to rules.",
    "phase_4_api_gateway": "RegisteredAgent authenticates via API key. AgentEvent is created on event ingestion. PolicyViolation created on rule match.",
    "phase_5_deliberation_engine": "AgentDefinition, PromptTemplate, Workflow, WorkflowStep, ConsensusPolicy drive the deliberation pipeline. AnalysisSession, AgentInstance, DeliberationMessage, Verdict are created during deliberation.",
    "phase_6_dashboard_liveviews": "All schemas displayed in dashboard views - events, agents, deliberations, verdicts.",
    "phase_7_admin_liveviews": "All configurable schemas have CRUD admin views.",
    "phase_8_demo_polish": "Demo seeder creates sample instances of all schemas."
  },
  "securityRules": {
    "mass_assignment": "Every schema changeset uses explicit cast/3 with ONLY user-editable fields. Sensitive fields (workspace_id, api_key_hash, evaluation_result, source_ip) set server-side only.",
    "xss_prevention": "All text fields (content, payload, system_prompt, reasoning) displayed in LiveViews auto-escaped. NEVER use raw/1 on user or LLM content.",
    "input_validation": "All text fields have max byte_size validation in changeset. Enum fields validate against Ecto.Enum values. Numeric fields have upper/lower bounds.",
    "audit_trail": "All CRUD on security-critical schemas (policy rules, detection rules, agent definitions, roles) create audit_entry records.",
    "no_code_execution": "Template interpolation uses safe String.replace/3 only. NEVER Code.eval_string or EEx.eval_string."
  },
  "userStories": [
    {
      "id": "SCHEMA-001",
      "title": "Create RegisteredAgent schema",
      "description": "RegisteredAgent represents an external AI agent that SwarmShield monitors. Each agent has an API key for authentication and metadata about its capabilities and risk profile.",
      "priority": 1,
      "passes": true,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "Schema at lib/swarmshield/gateway/registered_agent.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "Fields: name (string, required), description (string), api_key_hash (string, required), api_key_prefix (string, 8 chars for display), agent_type (Ecto.Enum :autonomous/:semi_autonomous/:tool_agent/:chatbot), status (Ecto.Enum :active/:suspended/:revoked), risk_level (Ecto.Enum :low/:medium/:high/:critical), metadata (map, default %{}), last_seen_at (utc_datetime), event_count (integer, default 0)",
        "Function: generate_api_key/0 returns {raw_key, hash, prefix}",
        "Changeset validates required [:name, :api_key_hash, :api_key_prefix, :workspace_id]",
        "Migration is idempotent",
        "Indexes: unique on :api_key_hash, index on [:workspace_id, :status], index on :agent_type",
        "Tests for valid/invalid changesets, API key generation",
        "Add registered_agent_fixture/1 to test/support/fixtures/gateway_fixtures.ex (creates workspace + agent)",
        "Edge case: test API key generation produces unique keys across 1000 iterations",
        "Edge case: test api_key_prefix is exactly 8 characters",
        "Edge case: test suspended agent cannot be reactivated to active directly (must go through review)",
        "Edge case: test agent_type enum rejects invalid values",
        "Edge case: test name uniqueness within workspace (same name allowed in different workspaces)",
        "Edge case: test metadata field accepts deeply nested maps (3+ levels)",
        "SECURITY: Changeset must use explicit cast/3 with only [:name, :description, :agent_type, :status, :risk_level, :allowed_actions, :metadata] - NEVER cast [:api_key_hash, :api_key_prefix, :event_count, :last_seen_at]",
        "SECURITY: API key generation must use :crypto.strong_rand_bytes(32), hashed with SHA256 matching ApiAuth plug pattern",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-002",
      "title": "Create AgentEvent schema",
      "description": "AgentEvent captures a single action or output from a monitored AI agent. This is the primary data ingested through the API gateway. Events are evaluated against policy rules.",
      "priority": 2,
      "passes": true,
      "dependsOn": [
        "SCHEMA-001"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Event types, statuses, and severities are Ecto.Enum (database-stored) - ZERO hardcoded event classification logic",
        "Schema at lib/swarmshield/gateway/agent_event.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "belongs_to :registered_agent",
        "Fields: event_type (Ecto.Enum :action/:output/:tool_call/:message/:error), content (text/string, required), payload (map, default %{}), source_ip (string), severity (Ecto.Enum :info/:warning/:error/:critical), status (Ecto.Enum :allowed/:flagged/:blocked/:pending), evaluation_result (map, default %{}), evaluated_at (utc_datetime), flagged_reason (string)",
        "Changeset validates required [:event_type, :content, :workspace_id, :registered_agent_id]",
        "Migration is idempotent",
        "Indexes: on [:workspace_id, :inserted_at], [:registered_agent_id, :inserted_at], :status, :event_type, [:workspace_id, :status]",
        "Tests for valid/invalid changesets",
        "Add agent_event_fixture/1 to test/support/fixtures/gateway_fixtures.ex",
        "Edge case: test content field accepts up to 1MB of text",
        "Edge case: test payload field accepts complex nested JSON structures",
        "Edge case: test event_type enum rejects invalid values",
        "Edge case: test status transitions are valid (pending -> allowed/flagged/blocked only)",
        "Edge case: test event with nil source_ip is valid (internal events)",
        "Edge case: test evaluated_at is set when status changes from :pending",
        "SECURITY: External-facing changeset must cast only [:event_type, :content, :payload, :severity] - NEVER cast [:status, :evaluation_result, :evaluated_at, :flagged_reason, :source_ip] from external input. These are set by PolicyEngine and conn",
        "SECURITY: Content and payload fields must have max byte_size validation in changeset (defense in depth)",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-003",
      "title": "Create PolicyRule schema",
      "description": "PolicyRule defines an allow/flag/block rule for evaluating agent events. Rules are ETS-cached for sub-millisecond evaluation. Each rule has a type (rate_limit, pattern_match, blocklist, payload_size) and configuration.",
      "priority": 3,
      "passes": true,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Rule types, actions, and config are database-driven - ZERO hardcoded policy rules in application code",
        "Schema at lib/swarmshield/policies/policy_rule.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "Fields: name (string, required), description (string), rule_type (Ecto.Enum :rate_limit/:pattern_match/:blocklist/:allowlist/:payload_size/:custom), action (Ecto.Enum :allow/:flag/:block), priority (integer, default 0, higher = evaluated first), enabled (boolean, default true), config (map, required - holds rule-specific configuration), applies_to_agent_types (array of strings, default []), applies_to_event_types (array of strings, default [])",
        "Changeset validates required [:name, :rule_type, :action, :config, :workspace_id]",
        "Migration is idempotent",
        "Indexes: on [:workspace_id, :enabled], [:workspace_id, :rule_type], [:workspace_id, :priority]",
        "Tests for valid/invalid changesets, config validation per rule_type",
        "Add policy_rule_fixture/1 to test/support/fixtures/policies_fixtures.ex",
        "Edge case: test config validation for rate_limit type requires max_events and window_seconds",
        "Edge case: test config validation for pattern_match type requires detection rule references",
        "Edge case: test config validation for blocklist type requires values list",
        "Edge case: test config validation for payload_size type requires max_content_bytes or max_payload_bytes",
        "Edge case: test priority ordering (higher number = higher priority)",
        "Edge case: test disabled rules are excluded from active rule lists",
        "Edge case: test applies_to_agent_types empty array means all agent types",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-004",
      "title": "Create DetectionRule schema",
      "description": "DetectionRule defines a pattern matcher (regex or keyword list) used by pattern_match policy rules. Separated from PolicyRule for reusability - multiple policy rules can reference the same detection patterns.",
      "priority": 4,
      "passes": true,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Detection patterns stored in database - ZERO hardcoded regex patterns or keyword lists in application code",
        "Schema at lib/swarmshield/policies/detection_rule.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "Fields: name (string, required), description (string), detection_type (Ecto.Enum :regex/:keyword/:semantic), pattern (string, required for regex), keywords (array of strings, required for keyword type), severity (Ecto.Enum :low/:medium/:high/:critical), enabled (boolean, default true), category (string - e.g. 'pii', 'toxicity', 'prompt_injection', 'data_exfiltration')",
        "Changeset validates required [:name, :detection_type, :workspace_id], conditionally requires :pattern or :keywords based on type",
        "Validates regex patterns compile successfully",
        "Migration is idempotent",
        "Indexes: on [:workspace_id, :enabled], [:workspace_id, :detection_type], [:workspace_id, :category]",
        "Tests for valid/invalid changesets, regex validation",
        "Add detection_rule_fixture/1 to test/support/fixtures/policies_fixtures.ex",
        "Edge case: test regex pattern that doesn't compile returns changeset error",
        "Edge case: test regex pattern with catastrophic backtracking is rejected (ReDoS protection)",
        "Edge case: test keyword type requires non-empty keywords array",
        "Edge case: test regex type requires non-empty pattern string",
        "Edge case: test semantic type stores metadata but doesn't require pattern or keywords",
        "Edge case: test category field accepts custom values (not restricted to enum)",
        "SECURITY: Regex pattern field must have maximum length validation (10,000 chars) in changeset to prevent memory abuse",
        "SECURITY: Keywords array must have maximum count limit (1,000) and per-keyword length limit (500 chars)",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-005",
      "title": "Create PolicyViolation schema",
      "description": "PolicyViolation records when an agent event matches a policy rule. Links the event to the rule that triggered and captures the evaluation details.",
      "priority": 5,
      "passes": true,
      "dependsOn": [
        "SCHEMA-002",
        "SCHEMA-003"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Violation details and resolution data are database-driven - ZERO hardcoded severity thresholds",
        "Schema at lib/swarmshield/policies/policy_violation.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "belongs_to :agent_event, Swarmshield.Gateway.AgentEvent",
        "belongs_to :policy_rule, Swarmshield.Policies.PolicyRule",
        "Fields: action_taken (Ecto.Enum :flagged/:blocked), severity (Ecto.Enum :low/:medium/:high/:critical), details (map, default %{} - evaluation context), resolved (boolean, default false), resolved_by_id (binary_id, references users), resolved_at (utc_datetime), resolution_notes (string)",
        "Changeset validates required [:action_taken, :severity, :workspace_id, :agent_event_id, :policy_rule_id]",
        "Migration is idempotent",
        "Indexes: on [:workspace_id, :inserted_at], [:agent_event_id], [:policy_rule_id], [:workspace_id, :resolved]",
        "Tests for valid/invalid changesets",
        "Add policy_violation_fixture/1 to test/support/fixtures/policies_fixtures.ex",
        "Edge case: test resolved violation has resolved_by_id and resolved_at set",
        "Edge case: test unresolved violation has nil resolved_by_id and resolved_at",
        "Edge case: test resolution_notes can be up to 5000 chars",
        "Edge case: test details map stores evaluation context faithfully",
        "Edge case: test violation cannot be created without valid agent_event_id (foreign key)",
        "Edge case: test violation cannot be created without valid policy_rule_id (foreign key)",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-006",
      "title": "Create AgentDefinition schema",
      "description": "AgentDefinition describes an internal Opus 4.6 analyzer persona used in deliberation. Each definition specifies the agent's role, expertise, and system prompt for the LLM.",
      "priority": 6,
      "passes": true,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Agent personas, system prompts, and model config are database-driven - ZERO hardcoded LLM prompts or model names in application code",
        "Schema at lib/swarmshield/deliberation/agent_definition.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "Fields: name (string, required), description (string), role (string, required - e.g. 'security_analyst', 'ethics_reviewer', 'compliance_officer'), expertise (array of strings - e.g. ['prompt_injection', 'data_privacy']), system_prompt (text/string, required), model (string, default 'claude-opus-4-6'), temperature (float, default 0.3), max_tokens (integer, default 4096), enabled (boolean, default true)",
        "Changeset validates required [:name, :role, :system_prompt, :workspace_id]",
        "Validates temperature between 0.0 and 1.0",
        "Validates max_tokens between 1 and 32768",
        "Migration is idempotent",
        "Indexes: on [:workspace_id, :enabled], [:workspace_id, :role]",
        "Tests for valid/invalid changesets, temperature/token validation",
        "Add agent_definition_fixture/1 to test/support/fixtures/deliberation_fixtures.ex",
        "Edge case: test temperature exactly 0.0 is valid",
        "Edge case: test temperature exactly 1.0 is valid",
        "Edge case: test temperature 1.01 is rejected",
        "Edge case: test temperature -0.1 is rejected",
        "Edge case: test max_tokens 0 is rejected",
        "Edge case: test max_tokens 32769 is rejected",
        "Edge case: test expertise empty array is valid (generalist agent)",
        "Edge case: test system_prompt can be up to 100KB",
        "SECURITY: system_prompt must enforce max byte_size validation in changeset (not just edge case test)",
        "SECURITY: model field must be validated against an allowlist of approved model identifiers from config",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-007",
      "title": "Create PromptTemplate schema",
      "description": "PromptTemplate stores variable-interpolated prompt templates used by agent definitions during deliberation. Templates use {{variable}} syntax for dynamic content injection.",
      "priority": 7,
      "passes": true,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Prompt templates stored in database with variable interpolation - ZERO hardcoded prompt text in application code",
        "Schema at lib/swarmshield/deliberation/prompt_template.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "Fields: name (string, required), description (string), template (text/string, required), variables (array of strings - extracted from {{var}} patterns), category (string - e.g. 'analysis', 'debate', 'verdict'), version (integer, default 1), enabled (boolean, default true)",
        "Function: extract_variables/1 parses template string and returns list of variable names",
        "Changeset validates required [:name, :template, :workspace_id]",
        "Changeset auto-extracts variables from template on insert/update",
        "Migration is idempotent",
        "Indexes: on [:workspace_id, :category], [:workspace_id, :enabled]",
        "Tests for valid/invalid changesets, variable extraction",
        "Add prompt_template_fixture/1 to test/support/fixtures/deliberation_fixtures.ex",
        "Edge case: test extract_variables returns empty list for template with no {{variables}}",
        "Edge case: test extract_variables handles nested braces {{{{var}}}} correctly",
        "Edge case: test extract_variables returns unique variable names (no duplicates)",
        "Edge case: test template with no variables is valid",
        "Edge case: test version auto-increments on update",
        "SECURITY: Template interpolation must NEVER use Code.eval_string or EEx.eval_string - only safe String.replace/3 with literal substitution",
        "SECURITY: Template field must enforce max byte_size validation in changeset",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-008",
      "title": "Create Workflow schema",
      "description": "Workflow defines an analysis pipeline - an ordered sequence of steps that process a flagged event through multiple AI agents. Each workflow has a name, trigger conditions, and an associated consensus policy.",
      "priority": 8,
      "passes": true,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Workflow configuration (trigger, timeout, retries) is database-driven - ZERO hardcoded workflow behavior",
        "Schema at lib/swarmshield/deliberation/workflow.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "has_many :workflow_steps, preload_order: [asc: :position]",
        "Fields: name (string, required), description (string), trigger_on (Ecto.Enum :flagged/:blocked/:manual/:all), enabled (boolean, default true), timeout_seconds (integer, default 300), max_retries (integer, default 2)",
        "Changeset validates required [:name, :trigger_on, :workspace_id]",
        "Validates timeout_seconds between 30 and 3600",
        "Migration is idempotent",
        "Indexes: on [:workspace_id, :enabled], [:workspace_id, :trigger_on]",
        "Tests for valid/invalid changesets, timeout validation",
        "Add workflow_fixture/1 to test/support/fixtures/deliberation_fixtures.ex",
        "Edge case: test timeout_seconds exactly 30 is valid (minimum)",
        "Edge case: test timeout_seconds exactly 3600 is valid (maximum)",
        "Edge case: test timeout_seconds 29 is rejected",
        "Edge case: test timeout_seconds 3601 is rejected",
        "Edge case: test workflow with no steps is valid (steps added separately)",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-009",
      "title": "Create WorkflowStep schema",
      "description": "WorkflowStep is an ordered step in a workflow pipeline. Each step references an agent definition and a prompt template. Steps can run in parallel or sequentially.",
      "priority": 9,
      "passes": true,
      "dependsOn": [
        "SCHEMA-008",
        "SCHEMA-006"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Step ordering, execution mode, and agent assignment are database-driven - ZERO hardcoded pipeline steps",
        "Schema at lib/swarmshield/deliberation/workflow_step.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workflow",
        "belongs_to :agent_definition",
        "belongs_to :prompt_template (optional)",
        "Fields: position (integer, required), name (string, required), execution_mode (Ecto.Enum :sequential/:parallel), timeout_seconds (integer, default 120), retry_count (integer, default 1), config (map, default %{})",
        "Changeset validates required [:position, :name, :workflow_id, :agent_definition_id]",
        "Validates position >= 1",
        "Migration is idempotent",
        "Indexes: unique on [:workflow_id, :position], on [:agent_definition_id]",
        "Tests for valid/invalid changesets, position uniqueness",
        "Add workflow_step_fixture/1 to test/support/fixtures/deliberation_fixtures.ex",
        "Edge case: test position 0 is rejected (must be >= 1)",
        "Edge case: test duplicate position within same workflow is rejected",
        "Edge case: test same position allowed in different workflows",
        "Edge case: test nil prompt_template_id is valid (optional)",
        "Edge case: test step deletion reorders remaining steps",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-010",
      "title": "Create ConsensusPolicy schema",
      "description": "ConsensusPolicy defines the voting strategy for reaching a verdict after deliberation. Supports majority, supermajority, unanimous, and weighted voting strategies.",
      "priority": 10,
      "passes": true,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Consensus strategy, threshold, and weights are database-driven - ZERO hardcoded voting logic parameters",
        "Schema at lib/swarmshield/deliberation/consensus_policy.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "Fields: name (string, required), description (string), strategy (Ecto.Enum :majority/:supermajority/:unanimous/:weighted), threshold (float - e.g. 0.5 for majority, 0.67 for supermajority), weights (map, default %{} - agent_role => weight for weighted voting), require_unanimous_on (array of strings - verdict types requiring unanimity, e.g. ['block']), enabled (boolean, default true)",
        "Changeset validates required [:name, :strategy, :workspace_id]",
        "Validates threshold between 0.0 and 1.0",
        "Migration is idempotent",
        "Indexes: on [:workspace_id, :enabled]",
        "Tests for valid/invalid changesets, threshold validation",
        "Add consensus_policy_fixture/1 to test/support/fixtures/deliberation_fixtures.ex",
        "Edge case: test threshold exactly 0.0 is valid",
        "Edge case: test threshold exactly 1.0 is valid",
        "Edge case: test threshold 1.01 is rejected",
        "Edge case: test threshold -0.1 is rejected",
        "Edge case: test weights map accepts string keys (agent role names)",
        "Edge case: test require_unanimous_on accepts empty array",
        "SECURITY: Weights map values must be validated as positive numbers - prevent negative weights that could invert voting outcomes",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-011",
      "title": "Create AnalysisSession schema",
      "description": "AnalysisSession represents a single deliberation instance - multiple AI agents analyzing a flagged event and debating to reach a verdict. Tracks the session lifecycle from pending through analysis, deliberation, to verdict.",
      "priority": 11,
      "passes": true,
      "dependsOn": [
        "SCHEMA-008",
        "SCHEMA-010"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "Schema at lib/swarmshield/deliberation/analysis_session.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :workspace",
        "belongs_to :workflow",
        "belongs_to :consensus_policy",
        "belongs_to :agent_event, Swarmshield.Gateway.AgentEvent",
        "has_many :agent_instances",
        "has_many :deliberation_messages",
        "has_one :verdict",
        "Fields: status (Ecto.Enum :pending/:analyzing/:deliberating/:voting/:completed/:failed/:timed_out), trigger (Ecto.Enum :automatic/:manual), started_at (utc_datetime), completed_at (utc_datetime), error_message (string), metadata (map, default %{}), total_tokens_used (integer, default 0), total_cost_cents (integer, default 0)",
        "Changeset validates required [:status, :trigger, :workspace_id, :workflow_id, :consensus_policy_id, :agent_event_id]",
        "Migration is idempotent",
        "Indexes: on [:workspace_id, :status], [:workspace_id, :inserted_at], [:agent_event_id], [:workflow_id]",
        "Tests for valid/invalid changesets",
        "Add analysis_session_fixture/1 to test/support/fixtures/deliberation_fixtures.ex",
        "Edge case: test status enum includes all valid statuses",
        "Edge case: test completed session has non-nil completed_at",
        "Edge case: test failed session has non-nil error_message",
        "Edge case: test total_tokens_used defaults to 0",
        "Edge case: test total_cost_cents defaults to 0",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-012",
      "title": "Create AgentInstance schema",
      "description": "AgentInstance represents a specific AI agent participating in an analysis session. Each instance is spawned from an AgentDefinition and tracks its individual analysis output.",
      "priority": 12,
      "passes": true,
      "dependsOn": [
        "SCHEMA-011",
        "SCHEMA-006"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Agent instance configuration inherited from database-driven AgentDefinition - ZERO hardcoded agent behavior",
        "Schema at lib/swarmshield/deliberation/agent_instance.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :analysis_session",
        "belongs_to :agent_definition",
        "has_many :deliberation_messages",
        "Fields: status (Ecto.Enum :pending/:running/:completed/:failed/:timed_out), role (string - copied from agent_definition for denormalization), started_at (utc_datetime), completed_at (utc_datetime), initial_assessment (text/string), vote (Ecto.Enum :allow/:flag/:block, nullable), confidence (float), tokens_used (integer, default 0), cost_cents (integer, default 0), error_message (string)",
        "Changeset validates required [:status, :analysis_session_id, :agent_definition_id]",
        "Validates confidence between 0.0 and 1.0 when present",
        "Migration is idempotent",
        "Indexes: on [:analysis_session_id, :status], [:agent_definition_id]",
        "Tests for valid/invalid changesets, confidence validation",
        "Add agent_instance_fixture/1 to test/support/fixtures/deliberation_fixtures.ex",
        "Edge case: test confidence nil is valid before analysis completes",
        "Edge case: test confidence exactly 0.0 is valid",
        "Edge case: test confidence exactly 1.0 is valid",
        "Edge case: test confidence 1.01 is rejected",
        "Edge case: test vote nil is valid before voting phase",
        "Edge case: test role is copied from agent_definition on creation",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-013",
      "title": "Create DeliberationMessage schema",
      "description": "DeliberationMessage captures individual messages in the deliberation phase - agent analyses, counter-arguments, and supporting evidence. This is the debate transcript.",
      "priority": 13,
      "passes": true,
      "dependsOn": [
        "SCHEMA-012"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "Schema at lib/swarmshield/deliberation/deliberation_message.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :analysis_session",
        "belongs_to :agent_instance",
        "Fields: message_type (Ecto.Enum :analysis/:argument/:counter_argument/:evidence/:summary/:vote_rationale), content (text/string, required), round (integer, default 1 - deliberation round number), in_reply_to_id (binary_id, self-referencing for threaded discussion), tokens_used (integer, default 0), metadata (map, default %{})",
        "Changeset validates required [:message_type, :content, :analysis_session_id, :agent_instance_id]",
        "Validates round >= 1",
        "Migration is idempotent",
        "Indexes: on [:analysis_session_id, :round], [:agent_instance_id], [:analysis_session_id, :message_type]",
        "Tests for valid/invalid changesets",
        "Add deliberation_message_fixture/1 to test/support/fixtures/deliberation_fixtures.ex",
        "Edge case: test round 0 is rejected (must be >= 1)",
        "Edge case: test in_reply_to_id nil is valid (first message in thread)",
        "Edge case: test in_reply_to_id references valid message ID",
        "Edge case: test content can be up to 100KB (long LLM responses)",
        "Edge case: test message_type enum rejects invalid values",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "SCHEMA-014",
      "title": "Create Verdict schema",
      "description": "Verdict is the final consensus decision from a deliberation session. Captures the collective vote, reasoning, and recommended action. One verdict per analysis session.",
      "priority": 14,
      "passes": true,
      "dependsOn": [
        "SCHEMA-011"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Verdict decisions and thresholds driven by database ConsensusPolicy - ZERO hardcoded verdict logic",
        "Schema at lib/swarmshield/deliberation/verdict.ex",
        "Uses @primary_key {:id, :binary_id, autogenerate: true}",
        "belongs_to :analysis_session",
        "Fields: decision (Ecto.Enum :allow/:flag/:block/:escalate), confidence (float, required), reasoning (text/string, required), dissenting_opinions (array of maps - [{agent_role, vote, rationale}]), vote_breakdown (map - %{allow: N, flag: N, block: N}), recommended_actions (array of strings), consensus_reached (boolean, default false), consensus_strategy_used (string)",
        "Changeset validates required [:decision, :confidence, :reasoning, :analysis_session_id]",
        "Validates confidence between 0.0 and 1.0",
        "Migration is idempotent",
        "Indexes: unique on :analysis_session_id (one verdict per session), on [:analysis_session_id]",
        "Tests for valid/invalid changesets, one-to-one relationship",
        "Add verdict_fixture/1 to test/support/fixtures/deliberation_fixtures.ex",
        "Edge case: test one verdict per analysis_session (unique constraint)",
        "Edge case: test confidence exactly 0.0 is valid",
        "Edge case: test confidence exactly 1.0 is valid",
        "Edge case: test confidence 1.01 is rejected",
        "Edge case: test dissenting_opinions can be empty array",
        "Edge case: test vote_breakdown values are non-negative integers",
        "Edge case: test recommended_actions can be empty array",
        "SECURITY: Verdicts must be immutable after creation (like audit entries) - no update changeset exposed",
        "SECURITY: decision field must validate against explicit allowlist [:allow, :flag, :block, :escalate] - prevent arbitrary atom creation",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    }
  ]
}