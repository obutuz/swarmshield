{
  "branchName": "ralph/phase-7-admin",
  "description": "Admin CRUD LiveViews for all database-driven configuration. Workflows, policies, detection rules, agent definitions, prompt templates, GhostProtocol retention configs, registered agents, settings, and user management. GhostProtocol admin enables full CRUD for retention policies (wipe strategy, crypto_shred, field selection) and detail views showing linked workflows and wipe history.",
  "phase": 7,
  "phaseName": "Admin LiveViews",
  "crossPhaseLinks": {
    "phase_1_auth_foundation": "All admin views require admin/super_admin role. User management for role assignment.",
    "phase_2_core_schemas": "CRUD views for all configurable schemas including GhostProtocolConfig (SCHEMA-015).",
    "phase_3_policy_engine": "Policy rule changes trigger ETS cache refresh via PubSub.",
    "phase_5_deliberation_engine": "Workflow/agent definition/prompt template changes affect future deliberations. GhostProtocol config changes affect DELIB-004 context and DELIB-013 wipe engine behavior.",
    "phase_6_dashboard_liveviews": "Admin sidebar links appear alongside dashboard navigation. GhostProtocol admin (ADMIN-008/009) complements GhostProtocol dashboard (DASH-009/010)."
  },
  "securityRules": {
    "authorization": "All admin views require admin or super_admin role. Permission checks on mount AND handle_event. EVERY state-changing handle_event re-verifies permission.",
    "mass_assignment": "Changesets explicitly cast only permitted fields. NEVER cast workspace_id, api_key_hash, is_system, version from form input. Sensitive fields set server-side.",
    "audit_trail": "All admin CRUD operations create audit entries. Audit entries for key regeneration must NOT log raw API key.",
    "xss": "Phoenix auto-escapes. All user-authored content (system_prompt, template content, blocklist values) auto-escaped on display. NEVER use raw/1.",
    "role_escalation": "Users cannot assign roles with MORE privileges than their own. Admin cannot create super_admin. analyst cannot create admin.",
    "redos_prevention": "Regex patterns validated for catastrophic backtracking before saving. Timeout-bounded compilation test.",
    "no_code_execution": "Template preview uses PromptRenderer.render/2 with safe String.replace only. NEVER Code.eval_string or EEx.",
    "ghost_protocol_admin": "GhostProtocol config deletion only allowed when no workflows are linked. Emergency force-wipe requires admin+ permission. Config changes broadcast via PubSub for cache invalidation."
  },
  "userStories": [
    {
      "id": "ADMIN-001",
      "title": "Create WorkflowsLive CRUD",
      "description": "Admin view for managing deliberation workflows. List all workflows with CRUD operations, status toggle, and link to step editor. Workflows may optionally link to a GhostProtocol config for ephemeral behavior.",
      "priority": 1,
      "passes": true,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Workflow CRUD operates on database records - all form values persisted to database, ZERO hardcoded defaults in UI",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/admin/workflows_live.ex",
        "Route: live '/admin/workflows', Admin.WorkflowsLive",
        "Permission check on mount: workflows:view",
        "Permission check on create/update/delete: workflows:create, workflows:update, workflows:delete",
        "List view with streams showing: name, trigger_on, enabled status, step count, ghost_protocol_config name (or 'Standard' if nil), actions",
        "Create/Edit as separate LiveView page (phx-debounce on all inputs)",
        "Fields: name, description, trigger_on (select), enabled (toggle), timeout_seconds, max_retries, ghost_protocol_config_id (optional select from workspace configs)",
        "GhostProtocol config select: dropdown showing workspace ghost_protocol_configs with 'None (Standard)' as default option",
        "Delete with confirmation dialog",
        "Enable/disable toggle with PubSub broadcast",
        "Link to WorkflowShowLive for step editing",
        "Audit entry on create/update/delete",
        "All data via Workflows context",
        "Tests for CRUD operations, permission checks",
        "Edge case: create form validates name uniqueness within workspace",
        "Edge case: delete workflow with active analysis sessions returns error with message",
        "Edge case: enable/disable toggle broadcasts PubSub event for cache refresh",
        "Edge case: empty workflow list shows 'No workflows configured' with create button",
        "Edge case: analyst/viewer role cannot see create/edit/delete buttons",
        "Edge case: form inputs all have phx-debounce='300' to reduce server load",
        "Edge case: ghost_protocol_config_id select only shows enabled configs from current workspace",
        "Edge case: workflow with linked ghost_protocol_config shows ghost icon badge in list",
        "Minimum 8 test cases",
        "SECURITY: handle_event for create/update/delete must re-verify permissions at event time (workflows:create/update/delete), not just on mount",
        "SECURITY: Workflow changeset must NEVER cast [:workspace_id] from form input - workspace_id set server-side from current_user's workspace",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-002",
      "title": "Create WorkflowShowLive step editor with GhostProtocol config link",
      "description": "Visual workflow step editor. Add, remove, reorder steps in a workflow. Each step configures an agent definition and optional prompt template. Shows linked GhostProtocol config details if present.",
      "priority": 2,
      "passes": true,
      "dependsOn": [
        "ADMIN-001"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Step editor reads agent definitions and templates from database - ZERO hardcoded step options",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/admin/workflow_show_live.ex",
        "Route: live '/admin/workflows/:id', Admin.WorkflowShowLive",
        "Permission check on mount: workflows:view",
        "Permission check on edit: workflows:update",
        "Displays workflow details at top (name, description, trigger)",
        "GhostProtocol config panel: if workflow has ghost_protocol_config_id, show linked config summary (wipe_strategy, crypto_shred, max_session_duration) with link to config detail page",
        "GhostProtocol badge: 'Ephemeral' badge with ghost icon when config is linked",
        "Step list displayed as ordered pipeline (vertical)",
        "Each step shows: position, name, agent definition name, execution_mode, timeout",
        "Add step form: name, agent_definition (select from enabled definitions), prompt_template (optional select), execution_mode, timeout_seconds",
        "Remove step with confirmation",
        "Drag-and-drop reorder (or up/down buttons) calls reorder_workflow_steps/2",
        "Audit entry on step changes",
        "All data via Workflows and Agents contexts",
        "Tests for step CRUD, reordering, GhostProtocol config display",
        "Edge case: workflow not found returns 404",
        "Edge case: add step with position auto-set to max_position + 1",
        "Edge case: remove last step from workflow is allowed (workflow can have 0 steps)",
        "Edge case: reorder handles drag to same position as no-op",
        "Edge case: agent_definition select only shows enabled definitions",
        "Edge case: prompt_template select shows 'None' option (optional field)",
        "Edge case: workflow without ghost_protocol_config shows 'Standard (non-ephemeral)' in config panel",
        "Minimum 6 test cases",
        "SECURITY: Verify workflow belongs to current_user's workspace before allowing step modifications",
        "SECURITY: Agent definition and prompt template select options must only show entities from current workspace",
        "SECURITY: handle_event for reorder/add/remove must verify workflows:update permission at event time",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-003",
      "title": "Create PoliciesLive consensus policy CRUD",
      "description": "Admin view for managing consensus policies (voting strategies). CRUD operations for majority, supermajority, unanimous, and weighted voting configurations.",
      "priority": 3,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Consensus policy CRUD operates on database records - strategy options and thresholds from DB",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/admin/policies_live.ex",
        "Route: live '/admin/consensus-policies', Admin.PoliciesLive",
        "Permission check on mount: policies:view",
        "Permission check on create/update/delete: policies:create, policies:update, policies:delete",
        "List view with streams: name, strategy, threshold, enabled",
        "Create/Edit as separate LiveView page (phx-debounce on all inputs)",
        "Fields: name, description, strategy (select), threshold (number input, 0-1), weights (key-value editor for weighted strategy), require_unanimous_on (multi-select)",
        "Conditional fields: threshold shown for majority/supermajority, weights shown for weighted",
        "Delete with confirmation",
        "Audit entry on changes",
        "All data via Workflows context",
        "Tests for CRUD, conditional field display",
        "Edge case: threshold field hidden for :unanimous strategy (always 1.0 implicitly)",
        "Edge case: weights field hidden for non-:weighted strategies",
        "Edge case: create with threshold=0 is valid for majority strategy",
        "Edge case: delete consensus policy referenced by analysis sessions returns error",
        "Edge case: form validates threshold is a number (not string)",
        "Minimum 6 test cases",
        "SECURITY: handle_event for create/update/delete must re-verify policies:create/update/delete permission at event time",
        "SECURITY: ConsensusPolicy changeset must NEVER cast [:workspace_id] from form input",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-004",
      "title": "Create PolicyRulesLive",
      "description": "Admin view for managing policy rules (allow/flag/block). CRUD with ETS cache refresh on changes. Each rule type has specific configuration fields.",
      "priority": 4,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Policy rule CRUD with all config values persisted to database - ZERO hardcoded rule defaults in forms",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/admin/policy_rules_live.ex",
        "Route: live '/admin/policy-rules', Admin.PolicyRulesLive",
        "Permission check on mount: policies:view",
        "Permission check on create/update/delete: policies:create, policies:update, policies:delete",
        "List view with streams: name, rule_type, action, priority, enabled",
        "Color-coded action badges: green (allow), yellow (flag), red (block)",
        "Create/Edit as separate LiveView page (phx-debounce on all inputs)",
        "Fields: name, description, rule_type (select), action (select), priority (number), enabled (toggle)",
        "Dynamic config fields based on rule_type: rate_limit (max_events, window_seconds), pattern_match (detection rule select), blocklist/allowlist (values textarea), payload_size (max_content_bytes, max_payload_bytes)",
        "PubSub broadcast on changes triggers ETS cache refresh",
        "Delete with confirmation",
        "Audit entry on changes",
        "All data via Policies context",
        "Tests for CRUD, dynamic config fields, cache refresh",
        "Edge case: changing rule_type in form resets config fields to defaults",
        "Edge case: rate_limit config validates max_events > 0 and window_seconds > 0",
        "Edge case: create rule triggers PolicyCache PubSub broadcast immediately",
        "Edge case: update rule triggers PolicyCache PubSub broadcast immediately",
        "Edge case: delete rule triggers PolicyCache PubSub broadcast immediately",
        "Edge case: priority field shown as number input with step=1",
        "Edge case: disabled rule shown with muted styling",
        "Minimum 8 test cases",
        "SECURITY: handle_event for create/update/delete must re-verify policies:create/update/delete permission at event time",
        "SECURITY: PolicyRule changeset must NEVER cast [:workspace_id] from form input",
        "SECURITY: rule_type and action must be validated against Ecto.Enum values on server-side (not just client-side select)",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-005",
      "title": "Create DetectionRulesLive",
      "description": "Admin view for managing detection rules (regex patterns and keyword lists). CRUD with regex validation and preview.",
      "priority": 5,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Detection rule CRUD with patterns/keywords persisted to database - ZERO hardcoded detection patterns",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/admin/detection_rules_live.ex",
        "Route: live '/admin/detection-rules', Admin.DetectionRulesLive",
        "Permission check on mount: policies:view",
        "Permission check on create/update/delete: policies:create, policies:update, policies:delete",
        "List view with streams: name, detection_type, category, severity, enabled",
        "Create/Edit as separate LiveView page (phx-debounce on all inputs)",
        "Fields: name, description, detection_type (select), category (select/input), severity (select), enabled (toggle)",
        "Conditional fields: pattern (textarea for regex), keywords (tag input for keyword list)",
        "Regex validation: test compile on input, show error if invalid",
        "Regex preview: test pattern against sample input text",
        "PubSub broadcast on changes triggers ETS cache refresh",
        "Delete with confirmation",
        "Audit entry on changes",
        "All data via Policies context",
        "Tests for CRUD, regex validation, keyword input",
        "Edge case: regex preview shows match highlights in sample text",
        "Edge case: invalid regex shows compile error message in real-time (phx-change)",
        "Edge case: keyword input allows comma-separated or newline-separated entry",
        "Edge case: switching detection_type clears pattern/keywords fields",
        "Edge case: create triggers PubSub for ETS cache refresh",
        "Edge case: update triggers PubSub for ETS cache refresh",
        "Minimum 6 test cases",
        "SECURITY: ReDoS prevention - regex patterns must be validated for catastrophic backtracking before saving. Test compile with timeout-bounded match against pathological input",
        "SECURITY: handle_event for create/update/delete must re-verify policies:create/update/delete permission at event time",
        "SECURITY: Regex validation must use Regex.compile/1 only - NEVER Code.eval_string for pattern testing",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-006",
      "title": "Create AgentDefinitionsLive",
      "description": "Admin view for managing Opus 4.6 agent definitions (AI personas used in deliberation). CRUD for agent configuration including system prompts and model parameters.",
      "priority": 6,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "LiveView at lib/swarmshield_web/live/admin/agent_definitions_live.ex",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Route: live '/admin/agent-definitions', Admin.AgentDefinitionsLive",
        "Permission check on mount: agents:view",
        "Permission check on create/update/delete: agents:create, agents:update, agents:delete",
        "List view with streams: name, role, model, temperature, enabled",
        "Create/Edit as separate LiveView page (phx-debounce on all inputs)",
        "Fields: name, description, role (input), expertise (tag input), system_prompt (large textarea), model (select: claude-opus-4-6, claude-sonnet-4-5-20250929), temperature (range slider 0-1), max_tokens (number input), enabled (toggle)",
        "System prompt preview with character count",
        "Delete with confirmation (prevent if used in active workflow steps)",
        "Audit entry on changes",
        "All data via Agents context",
        "Tests for CRUD, validation",
        "Edge case: delete definition used in workflow steps returns error with 'used in N workflows' message",
        "Edge case: system_prompt textarea auto-resizes based on content",
        "Edge case: temperature slider shows current value label",
        "Edge case: model select shows only supported models from config (not hardcoded)",
        "Edge case: expertise tag input allows adding/removing individual tags",
        "Minimum 6 test cases",
        "SECURITY: handle_event for create/update/delete must re-verify agents:create/update/delete permission at event time",
        "SECURITY: AgentDefinition changeset must NEVER cast [:workspace_id] from form input",
        "SECURITY: model field must be validated against allowlist from config, temperature between 0.0-1.0, max_tokens within model limits",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-007",
      "title": "Create PromptTemplatesLive",
      "description": "Admin view for managing prompt templates with variable interpolation preview. CRUD with template variable extraction and live preview.",
      "priority": 7,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Template CRUD with full template content in database - ZERO hardcoded prompt text",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/admin/prompt_templates_live.ex",
        "Route: live '/admin/prompt-templates', Admin.PromptTemplatesLive",
        "Permission check on mount: agents:view",
        "Permission check on create/update/delete: agents:create, agents:update, agents:delete",
        "List view with streams: name, category, variable count, version, enabled",
        "Create/Edit as separate LiveView page (phx-debounce on all inputs)",
        "Fields: name, description, category (select/input), template (large textarea), enabled (toggle)",
        "Live variable extraction: as user types template, detected {{variables}} shown below",
        "Preview panel: fill in sample variable values and see rendered output",
        "Uses PromptRenderer.extract_variables/1 for variable detection",
        "Uses PromptRenderer.render/2 for preview",
        "Delete with confirmation",
        "Audit entry on changes",
        "All data via Agents context",
        "Tests for CRUD, variable extraction, preview",
        "Edge case: variable extraction updates in real-time as user types",
        "Edge case: preview panel shows rendered template with sample values",
        "Edge case: preview with missing variable shows {{variable_name}} as-is",
        "Edge case: version number auto-incremented on update (not user-editable)",
        "Edge case: delete template referenced by workflow steps returns error",
        "Minimum 6 test cases",
        "SECURITY: handle_event for create/update/delete must re-verify agents:create/update/delete permission at event time",
        "SECURITY: Template preview must use PromptRenderer.render/2 with safe String.replace - NEVER Code.eval_string or EEx",
        "SECURITY: PromptTemplate changeset must NEVER cast [:workspace_id, :version] from form input - version auto-incremented server-side",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-008",
      "title": "Create GhostProtocolConfigsLive (retention policy CRUD)",
      "description": "Admin view for managing GhostProtocol retention configurations. Full CRUD for ghost_protocol_configs including wipe strategy selection, field targeting, crypto_shred toggle, and session duration limits. This is the admin interface for SwarmShield's flagship security feature - ephemeral agent lifecycle management.",
      "priority": 8,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: GhostProtocol config CRUD operates on database records - ALL wipe settings stored in ghost_protocol_configs table, ZERO hardcoded retention policies",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/admin/ghost_protocol_configs_live.ex",
        "Route: live '/admin/ghost-protocol', Admin.GhostProtocolConfigsLive",
        "Permission check on mount: ghost_protocol:view",
        "Permission check on create/update/delete: ghost_protocol:create, ghost_protocol:update, ghost_protocol:delete",
        "List view with streams: name, wipe_strategy (with icon), crypto_shred status, max_session_duration, linked workflow count, enabled",
        "Wipe strategy badges: immediate (red), delayed (yellow with delay seconds), scheduled (blue)",
        "Crypto_shred indicator: shield icon when true, dash when false",
        "Create/Edit as separate LiveView page (phx-debounce on all inputs)",
        "Create fields: name (text), slug (auto-generated from name, editable), wipe_strategy (select: immediate/delayed/scheduled), wipe_delay_seconds (number, shown only when strategy=delayed), wipe_fields (multi-select checkboxes: input_content, deliberation_messages, metadata), retain_verdict (toggle, default true), retain_audit (toggle, default true), max_session_duration_seconds (number), auto_terminate_on_expiry (toggle), crypto_shred (toggle with warning tooltip: 'Overwrites data with random bytes before nulling'), enabled (toggle)",
        "Conditional field visibility: wipe_delay_seconds only shown when wipe_strategy=delayed",
        "Live preview panel: shows summary of wipe behavior based on current form values ('When a session completes: [fields] will be [crypto shredded and] wiped after [N seconds]. Verdict and audit trail will be retained.')",
        "Delete with confirmation dialog - ONLY allowed if no workflows are linked to this config",
        "Delete blocked message: 'Cannot delete - N workflow(s) use this config: [workflow names]'",
        "Enable/disable toggle with PubSub broadcast",
        "Audit entry on create/update/delete",
        "All data via GhostProtocol context (DELIB-004)",
        "Tests for CRUD operations, permission checks, conditional fields",
        "Edge case: create form auto-generates slug from name (spaces to hyphens, lowercase)",
        "Edge case: slug uniqueness validated within workspace",
        "Edge case: wipe_delay_seconds validated > 0 when strategy=delayed",
        "Edge case: wipe_fields must have at least one field selected",
        "Edge case: retain_verdict and retain_audit default to true and show warning if toggled off",
        "Edge case: max_session_duration_seconds validated between 10 and 86400 (10s to 24h)",
        "Edge case: crypto_shred toggle shows security implications tooltip",
        "Edge case: empty config list shows 'No GhostProtocol configs' with ghost icon and create button",
        "Edge case: config with linked workflows shows workflow count badge",
        "Minimum 10 test cases",
        "SECURITY: handle_event for create/update/delete must re-verify ghost_protocol:create/update/delete permission at event time",
        "SECURITY: GhostProtocolConfig changeset must NEVER cast [:workspace_id] from form input - workspace_id set server-side",
        "SECURITY: wipe_strategy must be validated against Ecto.Enum values server-side",
        "SECURITY: wipe_fields array must be validated against known field names only (no arbitrary field injection)",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-009",
      "title": "Create GhostProtocolConfigShowLive (config detail + linked workflows)",
      "description": "Detail view for a specific GhostProtocol config. Shows all settings, linked workflows using this config, recent wipe history for sessions that used this config, and emergency force-wipe capability for active sessions.",
      "priority": 9,
      "passes": false,
      "dependsOn": [
        "ADMIN-008"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: All displayed data loaded from database via context functions - ZERO mock data",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/admin/ghost_protocol_config_show_live.ex",
        "Route: live '/admin/ghost-protocol/:id', Admin.GhostProtocolConfigShowLive",
        "Permission check on mount: ghost_protocol:view",
        "Config details card: name, slug, wipe_strategy, wipe_delay_seconds, wipe_fields list, retain_verdict, retain_audit, max_session_duration_seconds, auto_terminate_on_expiry, crypto_shred, enabled status",
        "Visual wipe behavior summary: diagram or text showing 'Session -> Verdict -> Wipe [fields] -> [Crypto shred] -> Done'",
        "Linked workflows section: streams of workflows using this ghost_protocol_config_id, with name, enabled status, step count, link to workflow detail",
        "Wipe history section: recent analysis_sessions that used workflows linked to this config, showing session_id, started_at, completed_at, wipe status (completed/pending/failed), fields wiped, crypto_shred applied",
        "Stats panel: total sessions using this config, total wipes completed, average session duration, data volume destroyed (estimated from wiped field sizes)",
        "Emergency force-wipe button (admin/super_admin only): triggers immediate wipe on all active sessions using workflows linked to this config",
        "Emergency force-wipe requires confirmation dialog with explicit warning text",
        "PubSub subscription to ghost_protocol topic for real-time wipe status updates",
        "Edit link back to GhostProtocolConfigsLive edit form",
        "All data via GhostProtocol context and Deliberation context",
        "Tests for config display, linked workflows, wipe history, force-wipe",
        "Edge case: config not found returns 404",
        "Edge case: config from different workspace returns 404 (not 403, prevents enumeration)",
        "Edge case: no linked workflows shows 'No workflows use this config' with link to create workflow",
        "Edge case: no wipe history shows 'No sessions have used this config yet'",
        "Edge case: force-wipe with no active sessions shows 'No active sessions to wipe'",
        "Edge case: force-wipe button hidden for analyst/viewer roles",
        "Edge case: wipe history pagination (database LIMIT/OFFSET, not client-side)",
        "Minimum 8 test cases",
        "SECURITY: handle_event for force-wipe must re-verify ghost_protocol:delete permission at event time",
        "SECURITY: Emergency force-wipe creates audit_entry with admin user_id and all affected session_ids",
        "SECURITY: Verify config belongs to current_user's workspace before displaying",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-010",
      "title": "Create SettingsLive",
      "description": "Workspace settings view for configuring workspace-level preferences. Budget limits, notification preferences, API configuration.",
      "priority": 10,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "LiveView at lib/swarmshield_web/live/admin/settings_live.ex",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Route: live '/admin/settings', Admin.SettingsLive",
        "Permission check on mount: settings:view",
        "Permission check on save: settings:update",
        "Sections: General (workspace name, description), Budget (monthly token limit, cost limit), Deliberation (default timeout, max rounds, default consensus policy), API (regenerate API key with confirmation)",
        "All settings stored in workspace.settings map (database-driven, not hardcoded)",
        "Form with phx-debounce on all inputs",
        "Save button updates workspace via Accounts context",
        "API key regeneration: generates new key, shows it ONCE, hashes and stores",
        "Audit entry on settings changes",
        "Tests for settings display, update, API key regeneration",
        "Edge case: API key shown only once after generation (flash/inline display with copy button)",
        "Edge case: regenerate API key requires confirmation dialog with warning text",
        "Edge case: budget settings validate positive numbers only",
        "Edge case: settings form saves partial updates (doesn't require all fields)",
        "Edge case: unsaved changes warning on navigate away (phx-hook with beforeunload)",
        "Minimum 6 test cases",
        "SECURITY: handle_event for save/regenerate must re-verify settings:update permission at event time",
        "SECURITY: Settings update changeset must NEVER allow updating [:id, :api_key_hash, :inserted_at] via form",
        "SECURITY: API key regeneration must invalidate old key immediately - all existing API sessions using old key rejected",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-011",
      "title": "Create UsersLive",
      "description": "User management view for workspace admins. View users in workspace, invite new users, assign/change roles, remove users from workspace.",
      "priority": 11,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "LiveView at lib/swarmshield_web/live/admin/users_live.ex",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Route: live '/admin/users', Admin.UsersLive",
        "Permission check on mount: settings:view",
        "Permission check on manage: settings:update",
        "List view with streams: email, role name, joined date, last activity",
        "Invite user form: email input, role select (from database roles)",
        "Change role: dropdown to change user's workspace role",
        "Remove user: remove from workspace (not delete account) with confirmation",
        "Cannot remove yourself or the last super_admin",
        "All data via Accounts context functions",
        "Audit entry on role changes and removals",
        "Tests for user listing, role change, removal, edge cases",
        "Edge case: cannot remove yourself from workspace (returns error)",
        "Edge case: cannot remove last super_admin (returns error with message)",
        "Edge case: cannot change own role (prevents accidental lockout)",
        "Edge case: invite sends email notification via Swoosh mailer",
        "Edge case: role change broadcasts PubSub event for real-time sidebar update",
        "Edge case: empty user list shows 'No users in workspace' (shouldn't happen normally)",
        "Minimum 8 test cases",
        "SECURITY: Role escalation prevention - users cannot assign roles with MORE privileges than their own (admin cannot create super_admin, analyst cannot create admin)",
        "SECURITY: handle_event for invite/role-change/remove must re-verify settings:update permission at event time",
        "SECURITY: When user's role is changed or removed, their active LiveView sessions for that workspace must be invalidated",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-012",
      "title": "Create RegisteredAgentsLive CRUD",
      "description": "Admin view for managing registered external AI agents. CRUD operations including API key generation, status management (active/suspended), and risk level configuration.",
      "priority": 12,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Agent registration data stored in database - ZERO hardcoded agent configs. API keys generated and hashed per schema conventions",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/admin/registered_agents_live.ex",
        "Route: live '/admin/registered-agents', Admin.RegisteredAgentsLive",
        "Permission check on mount: agents:view",
        "Permission check on create/update/delete: agents:create, agents:update, agents:delete",
        "List view with streams: name, agent_type, status (active/suspended), risk_level, API key prefix, last_seen_at, event_count",
        "Create as separate LiveView page (phx-debounce on all inputs): name, description, agent_type (select), allowed_actions (multi-select), metadata (key-value editor)",
        "On create: auto-generate API key via :crypto.strong_rand_bytes, show raw key ONCE on success page with copy button, store SHA256 hash in database",
        "Edit form: name, description, agent_type, status (active/suspended), risk_level (select), allowed_actions, metadata",
        "Suspend/Resume toggle: changes status between active and suspended",
        "Regenerate API key: confirmation dialog warning old key invalidated, generates new key, shows ONCE",
        "Delete with confirmation (prevent if agent has events in last 24h)",
        "Color-coded status: green (active), red (suspended)",
        "Color-coded risk level: green (low), yellow (medium), red (high), purple (critical)",
        "Audit entry on create/update/delete/suspend/resume/key_regenerate",
        "All data via Gateway context functions",
        "Tests for CRUD operations, API key generation, status toggle, permission checks",
        "Edge case: API key shown only once on create (cannot be retrieved later)",
        "Edge case: regenerate key invalidates old key immediately",
        "Edge case: suspend agent immediately blocks all API requests from that agent",
        "Edge case: delete agent with recent events (< 24h) returns error with message",
        "Edge case: agent_type select options loaded from Ecto.Enum values (not hardcoded list)",
        "Edge case: risk_level defaults to :low on create (from schema default, not UI hardcode)",
        "Edge case: metadata key-value editor allows adding/removing pairs dynamically",
        "Edge case: API key prefix shown as 'sk-xxxxxxxx' (first 8 chars visible, rest masked)",
        "Minimum 10 test cases",
        "SECURITY: handle_event for create/edit/suspend/resume/regenerate-key/delete must re-verify agents:create/update/delete permission at event time",
        "SECURITY: RegisteredAgent changeset must NEVER cast [:api_key_hash, :api_key_prefix, :workspace_id] from form input",
        "SECURITY: API key generation must use :crypto.strong_rand_bytes(32), hashed with SHA256. Audit entry for key regeneration must NOT log raw key",
        "SECURITY: When agent is suspended, all API requests using that agent's key must be rejected immediately",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "ADMIN-013",
      "title": "Sidebar navigation with role-based menu items including GhostProtocol",
      "description": "Update sidebar navigation to show menu items based on user's role and permissions. Dashboard items visible to all, admin items only to admin/super_admin. Includes GhostProtocol section in both dashboard and admin areas.",
      "priority": 13,
      "passes": false,
      "dependsOn": [
        "ADMIN-001",
        "ADMIN-002",
        "ADMIN-003",
        "ADMIN-004",
        "ADMIN-005",
        "ADMIN-006",
        "ADMIN-007",
        "ADMIN-008",
        "ADMIN-009",
        "ADMIN-010",
        "ADMIN-011",
        "ADMIN-012"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Sidebar menu items driven by database-stored permissions - ZERO hardcoded role-to-menu mapping",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Update lib/swarmshield_web/components/layouts/app.html.heex",
        "Dashboard section (all roles with appropriate permissions): Dashboard, Events, Agents, Deliberations, GhostProtocol (ghost icon), Audit Log",
        "GhostProtocol dashboard item: links to GhostProtocolLive (DASH-009), requires ghost_protocol:view permission, shows ghost/skull icon",
        "Admin section (admin/super_admin only): Workflows, Consensus Policies, Policy Rules, Detection Rules, Agent Definitions, Prompt Templates, GhostProtocol Configs, Registered Agents, Settings, Users",
        "GhostProtocol admin item: links to GhostProtocolConfigsLive (ADMIN-008), requires ghost_protocol:view permission",
        "Menu items check permissions via Authorization.has_permission?/3",
        "Active item highlighted based on current route",
        "Icons for each menu item (Heroicons)",
        "Collapsible admin section",
        "Mobile navigation with all items",
        "Tests for role-based visibility",
        "Edge case: super_admin sees all menu items including GhostProtocol",
        "Edge case: admin sees all dashboard + admin items including GhostProtocol",
        "Edge case: analyst sees dashboard items + deliberations:trigger + ghost_protocol:view",
        "Edge case: viewer sees only view-level dashboard items",
        "Edge case: Heroicons loaded correctly (not broken icon references)",
        "Edge case: menu item count badges show real-time counts via PubSub",
        "Edge case: GhostProtocol menu item shows active session count badge",
        "Minimum 4 test cases",
        "SECURITY: Menu item visibility computed server-side from database permissions - hiding menu items is NOT a substitute for server-side auth checks on each LiveView",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    }
  ]
}
