{
  "branchName": "ralph/phase-6-dashboard",
  "description": "Real-time security operations center dashboard. LiveViews for monitoring events, agents, deliberations, and audit logs with PubSub-driven real-time updates.",
  "phase": 6,
  "phaseName": "Dashboard LiveViews",
  "crossPhaseLinks": {
    "phase_1_auth_foundation": "All views use auth hooks for workspace scoping and permission checks.",
    "phase_2_core_schemas": "Displays all domain schemas - events, agents, sessions, verdicts.",
    "phase_3_policy_engine": "Dashboard shows policy evaluation stats and violation counts.",
    "phase_4_api_gateway": "Subscribes to PubSub for real-time event and violation updates.",
    "phase_5_deliberation_engine": "Subscribes to PubSub for real-time deliberation progress.",
    "phase_7_admin_liveviews": "Dashboard links to admin configuration views.",
    "phase_8_demo_polish": "Dashboard populated by demo simulator."
  },
  "securityRules": {
    "authorization": "All mount/0 check permissions via on_mount hooks. All handle_event re-verify permissions (not just mount).",
    "workspace_scoping": "PubSub topics use workspace_id from server-side assigns. Detail views verify loaded record belongs to current workspace. Return 404 for wrong-workspace (not 403).",
    "xss": "Phoenix auto-escapes all rendered content. NEVER use raw/1 on event content, payload, deliberation messages, verdict reasoning, or any user/LLM-generated text.",
    "data_exposure": "Only show data within current workspace scope. API key displayed only as masked prefix. JSON payloads escaped on display.",
    "no_repo_in_liveview": "All data loaded through context functions, never direct Repo calls.",
    "csrf": "All state-changing actions use POST. Logout uses DELETE with CSRF token. Export uses POST.",
    "input_validation": "All search/filter params validated via changeset or allowlist before query construction. NEVER interpolate search terms into SQL."
  },
  "userStories": [
    {
      "id": "DASH-001",
      "title": "Create app layout with sidebar navigation",
      "description": "Application layout with dark-themed sidebar navigation, workspace selector, and user menu. This is the shell that all dashboard and admin views render within.",
      "priority": 1,
      "passes": false,
      "dependsOn": [],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "Layout at lib/swarmshield_web/components/layouts/app.html.heex",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Dark theme: bg-gray-900 text-gray-100 color scheme",
        "Sidebar with navigation links: Dashboard, Events, Agents, Deliberations, Audit Log",
        "Admin section in sidebar (only visible to admin/super_admin roles): Workflows, Policies, Detection Rules, Agent Definitions, Prompt Templates, Settings, Users",
        "Workspace name displayed in sidebar header",
        "User menu with email and logout link",
        "Mobile responsive: hamburger menu on small screens",
        "Active navigation item highlighted",
        "Uses Phoenix 1.8 layout patterns (Layouts.app wrapper)",
        "Sidebar navigation uses role-based visibility via assigns",
        "Tests for layout rendering with different roles",
        "Edge case: sidebar collapses on mobile (< 768px)",
        "Edge case: active nav item highlighted correctly for nested routes (e.g., /events/123 highlights Events)",
        "Edge case: admin section hidden for analyst and viewer roles",
        "Edge case: workspace name truncated with ellipsis if too long (> 20 chars)",
        "Edge case: logout link calls DELETE /users/log_out",
        "SECURITY: Logout link must use DELETE method with CSRF token (form submit, not GET link)",
        "SECURITY: Verify put_secure_browser_headers in browser pipeline includes CSP, X-Frame-Options, X-Content-Type-Options",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DASH-002",
      "title": "Create DashboardLive",
      "description": "Main dashboard showing real-time security metrics: total events, flagged/blocked counts, active agents, active deliberations. Stat cards and event activity chart.",
      "priority": 2,
      "passes": false,
      "dependsOn": [
        "DASH-001"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "LiveView at lib/swarmshield_web/live/dashboard_live.ex",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Route: live '/dashboard', DashboardLive",
        "Permission check on mount: dashboard:view",
        "Stat cards: Total Events (24h), Flagged Events, Blocked Events, Active Agents, Active Deliberations, Verdicts Today",
        "Stats loaded via context functions (not direct Repo)",
        "Subscribes to PubSub 'events:workspace_id' for real-time counter updates",
        "Subscribes to PubSub 'deliberations:workspace_id' for session updates",
        "handle_info updates stat counters on new events (no full page reload)",
        "Uses assign_async for initial data load (extract values before callback)",
        "Dark theme styling consistent with layout",
        "Responsive grid: 3 columns desktop, 2 tablet, 1 mobile",
        "Tests for mount, PubSub updates, permission check",
        "Edge case: empty workspace (no events) shows 0 counts, not errors",
        "Edge case: PubSub event increments counter without full data reload",
        "Edge case: disconnected socket shows reconnecting indicator",
        "Edge case: assign_async values extracted BEFORE callback (verified no socket copying)",
        "Edge case: stats use database aggregate queries (COUNT, not Enum.count on loaded records)",
        "Minimum 6 test cases",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DASH-003",
      "title": "Create EventsLive",
      "description": "Event list view with real-time streaming, filtering by status/type/agent, and search. Uses LiveView streams for efficient DOM updates at scale.",
      "priority": 3,
      "passes": false,
      "dependsOn": [
        "DASH-001"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "LiveView at lib/swarmshield_web/live/events_live.ex",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Route: live '/events', EventsLive",
        "Permission check on mount: events:view",
        "Uses streams for event list (not assigns) for efficient 20M+ user scale",
        "Filters: status (allowed/flagged/blocked), event_type, registered_agent, date range",
        "Search: content text search",
        "Pagination: cursor-based or offset/limit",
        "Subscribes to PubSub 'events:workspace_id' for real-time new events",
        "New events prepended to stream via stream_insert",
        "Filter form with phx-debounce on all inputs",
        "Color-coded status badges: green (allowed), yellow (flagged), red (blocked)",
        "Each row links to EventShowLive",
        "All data via context functions (no direct Repo)",
        "Tests for mount, filtering, stream updates",
        "Edge case: empty event list shows 'No events yet' message",
        "Edge case: filter form preserves values on submit",
        "Edge case: stream_insert on PubSub event prepends to top of list",
        "Edge case: pagination loads next page without losing existing stream items",
        "Edge case: search with empty string returns all events",
        "Edge case: combined filters (status AND type AND agent) work correctly",
        "Minimum 8 test cases",
        "SECURITY: Search/content text search must use parameterized queries (ilike with ^value) - NEVER string interpolation",
        "SECURITY: All filter params (status, event_type, agent, date range) validated against allowlists before query construction",
        "SECURITY: handle_event for filter/search must re-verify events:view permission (not just mount)",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DASH-004",
      "title": "Create EventShowLive",
      "description": "Event detail view showing full event data, policy evaluation results, matched rules, and linked deliberation session if any.",
      "priority": 4,
      "passes": false,
      "dependsOn": [
        "DASH-003"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: All displayed data loaded from database via context functions - ZERO hardcoded event data or mock displays",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/event_show_live.ex",
        "Route: live '/events/:id', EventShowLive",
        "Permission check on mount: events:view",
        "Displays: event_type, content, payload (formatted JSON), status, severity, source_ip, timestamps",
        "Shows evaluation_result: matched rules with names and actions",
        "Shows linked PolicyViolations if any",
        "Shows linked AnalysisSession with verdict if deliberation occurred",
        "Link to trigger manual deliberation (if has deliberations:trigger permission)",
        "Back button to EventsLive",
        "All data via context functions with preloads",
        "Tests for mount, event display, linked data",
        "Edge case: event not found returns 404",
        "Edge case: event in different workspace returns 403",
        "Edge case: event with no violations shows 'No violations' section",
        "Edge case: event with no deliberation shows 'No deliberation' section with trigger button",
        "Edge case: trigger deliberation button only visible with deliberations:trigger permission",
        "Minimum 6 test cases",
        "SECURITY: Event loaded by :id must be verified to belong to current_user's workspace - return 404 for wrong-workspace (not 403)",
        "SECURITY: 'trigger deliberation' handle_event must verify deliberations:trigger permission at event time, not just conditionally render button",
        "SECURITY: Payload displayed as formatted JSON must be auto-escaped - no raw/1 on JSON output",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DASH-005",
      "title": "Create AgentsLive",
      "description": "Registered agent registry showing all monitored AI agents with their status, risk level, event counts, and last activity.",
      "priority": 5,
      "passes": false,
      "dependsOn": [
        "DASH-001"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "LiveView at lib/swarmshield_web/live/agents_live.ex",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Route: live '/agents', AgentsLive",
        "Permission check on mount: agents:view",
        "Uses streams for agent list",
        "Displays: name, agent_type, status, risk_level, event_count, last_seen_at",
        "Filter by: status, agent_type, risk_level",
        "Color-coded risk level badges",
        "Status indicator (green dot for active, red for suspended)",
        "Each row links to AgentShowLive",
        "All data via Gateway context functions",
        "Tests for mount, filtering",
        "Edge case: empty agent list shows 'No agents registered' message",
        "Edge case: last_seen_at shows relative time (e.g., '5 minutes ago')",
        "Edge case: agent with 0 events shows '-' not 0",
        "Minimum 4 test cases",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DASH-006",
      "title": "Create AgentShowLive",
      "description": "Agent detail view showing agent configuration, recent events, violation history, and activity timeline.",
      "priority": 6,
      "passes": false,
      "dependsOn": [
        "DASH-005"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: All agent details and stats from database queries - ZERO hardcoded agent information",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/agent_show_live.ex",
        "Route: live '/agents/:id', AgentShowLive",
        "Permission check on mount: agents:view",
        "Displays: name, description, agent_type, status, risk_level, API key prefix (masked), metadata",
        "Recent events tab: last 50 events via streams",
        "Violations tab: linked policy violations",
        "Stats: total events, flagged count, blocked count, last 24h activity",
        "Subscribes to PubSub for real-time event updates for this agent",
        "All data via context functions with preloads",
        "Tests for mount, tab switching, real-time updates",
        "Edge case: agent not found returns 404",
        "Edge case: agent with no events shows empty events tab",
        "Edge case: API key displayed as masked 'sk-xxxxxxxx' (only prefix shown)",
        "Edge case: PubSub subscription filtered to this specific agent's events",
        "Minimum 5 test cases",
        "SECURITY: Agent loaded by :id must be verified to belong to current_user's workspace - return 404 for wrong-workspace",
        "SECURITY: API key must NEVER be retrievable even masked - only display static prefix set at creation time",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DASH-007",
      "title": "Create DeliberationsLive",
      "description": "Deliberation session list showing all analysis sessions with status, workflow used, verdict outcome, and timing.",
      "priority": 7,
      "passes": false,
      "dependsOn": [
        "DASH-001"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: All deliberation data from database - ZERO hardcoded session info or mock deliberation displays",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "LiveView at lib/swarmshield_web/live/deliberations_live.ex",
        "Route: live '/deliberations', DeliberationsLive",
        "Permission check on mount: deliberations:view",
        "Uses streams for session list",
        "Displays: status, workflow name, trigger type, verdict decision (if completed), confidence, duration, cost",
        "Filter by: status, trigger type, verdict decision",
        "Status badges with icons: analyzing (spinner), deliberating (chat), voting (ballot), completed (check), failed (x)",
        "Each row links to DeliberationShowLive",
        "Subscribes to PubSub 'deliberations:workspace_id' for real-time updates",
        "All data via Deliberation context functions",
        "Tests for mount, filtering, real-time updates",
        "Edge case: empty deliberation list shows 'No deliberations yet' message",
        "Edge case: active session (status: :analyzing/:deliberating) shows animated spinner",
        "Edge case: PubSub update for session status change updates stream in place",
        "Edge case: completed session shows verdict decision as colored badge",
        "Minimum 5 test cases",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DASH-008",
      "title": "Create DeliberationShowLive",
      "description": "Real-time deliberation viewer showing the live debate between AI agents. Displays analysis, arguments, counter-arguments, and the final verdict as they happen.",
      "priority": 8,
      "passes": false,
      "dependsOn": [
        "DASH-007"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "LiveView at lib/swarmshield_web/live/deliberation_show_live.ex",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Route: live '/deliberations/:id', DeliberationShowLive",
        "Permission check on mount: deliberations:view",
        "Displays session info: status, workflow, trigger, event summary, timing",
        "Agent panel: shows each participating agent with their role, assessment, vote, confidence",
        "Message timeline: chronological display of all deliberation messages grouped by round",
        "Messages color-coded by type: analysis (blue), argument (green), counter_argument (orange), evidence (purple)",
        "Verdict panel: decision, confidence, reasoning, vote breakdown, dissenting opinions",
        "Subscribes to PubSub 'deliberation:session_id' for real-time message updates",
        "New messages appear live without page refresh (stream_insert)",
        "Verdict appears automatically when reached",
        "All data via Deliberation context functions with preloads",
        "Tests for mount, real-time message display, verdict display",
        "Edge case: session not found returns 404",
        "Edge case: session in :pending status shows 'Waiting to start' state",
        "Edge case: new messages appear via PubSub without page refresh",
        "Edge case: verdict panel hidden until verdict exists, then appears with animation",
        "Edge case: message timeline scrolls to bottom on new message",
        "Edge case: agents panel shows vote as '?' until voting phase completes",
        "Minimum 8 test cases",
        "SECURITY: Session loaded by :id must be verified to belong to current_user's workspace",
        "SECURITY: Deliberation message content (LLM-generated) may echo user-supplied event content (stored XSS risk) - verify all content auto-escaped with no raw/1",
        "SECURITY: PubSub topic 'deliberation:session_id' must verify session belongs to user's workspace before subscribing",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DASH-009",
      "title": "Create AuditLive",
      "description": "Paginated audit log showing all system actions. Filterable by action type, actor, resource, and date range. Immutable - view only.",
      "priority": 9,
      "passes": false,
      "dependsOn": [
        "DASH-001"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "LiveView at lib/swarmshield_web/live/audit_live.ex",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Route: live '/audit', AuditLive",
        "Permission check on mount: audit:view",
        "Uses streams for audit entry list",
        "Displays: action, resource_type, resource_id, actor_email, ip_address, timestamp, metadata preview",
        "Filter by: action, resource_type, actor, date range",
        "Search by actor email or resource ID",
        "Pagination (offset/limit, not cursor - audit is immutable)",
        "Export button (if has audit:export permission)",
        "No edit/delete actions (audit is immutable)",
        "Filter form with phx-debounce on all inputs",
        "All data via Accounts.list_audit_entries/1",
        "Tests for mount, filtering, pagination, export permission",
        "Edge case: empty audit log shows 'No audit entries' message",
        "Edge case: metadata preview shows first 100 chars with expand option",
        "Edge case: date range filter defaults to last 7 days",
        "Edge case: export button hidden for users without audit:export permission",
        "Edge case: pagination total_count shown (e.g., 'Showing 1-25 of 1,234')",
        "Minimum 6 test cases",
        "SECURITY: Search by actor email or resource ID must use parameterized queries - NEVER string interpolation",
        "SECURITY: Audit metadata preview must be escaped - metadata may contain sensitive data that was accidentally logged",
        "SECURITY: Export action must use POST with CSRF token, not GET link",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    },
    {
      "id": "DASH-010",
      "title": "Create workspace selector component",
      "description": "Dropdown component in the sidebar that allows users to switch between workspaces they belong to. Persists selected workspace in session and redirects to dashboard on switch.",
      "priority": 10,
      "passes": false,
      "dependsOn": [
        "DASH-001"
      ],
      "acceptanceCriteria": [
        "MANDATORY: Read progress.txt for existing implementations BEFORE coding - NO DUPLICATES",
        "MANDATORY: Comply with docs/UI_PATTERNS.md - dark theme (bg-gray-900/800), text-3xl font-bold for titles, space-y-6 content wrapper, bg-gray-800 border border-gray-700 for cards (NOT shadow/DaisyUI), phx-debounce='300' on ALL inputs, h-[44px] buttons, Tailwind status badges (NOT DaisyUI), streams for lists, empty states with icon+message, responsive at 320px/768px/1024px, PubSub subscriptions, max 1200 lines per file",
        "Component integrated into sidebar header in app.html.heex layout",
        "Dropdown shows all workspaces the current user belongs to (via Accounts.list_user_workspaces/1)",
        "Current workspace highlighted with checkmark icon",
        "Each workspace shows name and user's role in that workspace",
        "Switching workspace stores selected workspace_id in session via phx-click to a controller",
        "WorkspaceController.switch/2 at POST /workspaces/:id/switch updates session and redirects to /dashboard",
        "Dropdown styled dark theme: bg-gray-800 border-gray-700, hover:bg-gray-700",
        "Dropdown closes on click outside (JS hook or phx-click-away)",
        "Current workspace name displayed in sidebar header (truncated if > 20 chars)",
        "Tests for workspace listing, switch action, session persistence",
        "Edge case: user with only 1 workspace still sees selector (but no switch needed)",
        "Edge case: switching workspace clears any page-specific assigns and redirects to /dashboard",
        "Edge case: workspace selector shows role badge next to each workspace name",
        "Edge case: invalid workspace_id in switch returns 403 (user doesn't belong)",
        "Edge case: workspace name truncated with ellipsis if > 20 characters",
        "Edge case: dropdown positioned correctly on mobile (full width)",
        "Minimum 5 test cases",
        "SECURITY: WorkspaceController.switch/2 must verify user actually belongs to target workspace via database lookup - never trust workspace_id param alone",
        "SECURITY: Workspace switch must create audit_entry record for security monitoring",
        "mix format passes",
        "mix credo --strict passes",
        "mix test passes"
      ]
    }
  ]
}